<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/profile"></ion-back-button>
    </ion-buttons>
    <ion-title>
      <ion-icon name="location-outline" class="ion-margin-end"></ion-icon>
      {{ isEditing ? 'Editar Direcci贸n' : 'Nueva Direcci贸n' }}
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">{{ isEditing ? 'Editar Direcci贸n' : 'Nueva Direcci贸n' }}</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando direcci贸n...</p>
  </div>

  <!-- Formulario -->
  <ion-card *ngIf="!loading">
    <ion-card-content>
      <form (ngSubmit)="saveAddress()">
        <!-- Tipo de direcci贸n -->
        <ion-item>
          <ion-label position="stacked">Tipo de Direcci贸n *</ion-label>
          <ion-select
            [(ngModel)]="address.type"
            name="type"
            placeholder="Selecciona el tipo">
            <ion-select-option value="shipping">Env铆o</ion-select-option>
            <!-- <ion-select-option value="billing">Facturaci贸n</ion-select-option> -->
            <!-- <ion-select-option value="both">Env铆o y Facturaci贸n</ion-select-option> -->
          </ion-select>
        </ion-item>

        <!-- Nombre -->
        <ion-item>
          <ion-label position="stacked">Nombre *</ion-label>
          <ion-input
            [(ngModel)]="address.first_name"
            name="first_name"
            placeholder="Ingresa tu nombre"
            required>
          </ion-input>
        </ion-item>
        <ion-text *ngIf="getFieldError('first_name')" color="danger" class="error-text">
          <small>{{ getFieldError('first_name') }}</small>
        </ion-text>

        <!-- Apellido -->
        <ion-item>
          <ion-label position="stacked">Apellido *</ion-label>
          <ion-input
            [(ngModel)]="address.last_name"
            name="last_name"
            placeholder="Ingresa tu apellido"
            required>
          </ion-input>
        </ion-item>
        <ion-text *ngIf="getFieldError('last_name')" color="danger" class="error-text">
          <small>{{ getFieldError('last_name') }}</small>
        </ion-text>

        <!-- Direcci贸n con autocompletado -->
        <ion-item>
          <ion-label position="stacked">Direcci贸n *</ion-label>
          <ion-textarea
            [(ngModel)]="address.address_line_1"
            name="address_line_1"
            placeholder="Calle, n煤mero, colonia"
            (ionInput)="searchAddressSuggestions($event.detail.value || '')"
            (ionBlur)="hideSuggestions()"
            required>
          </ion-textarea>
        </ion-item>

        <!-- Sugerencias de direcciones -->
        <ion-card *ngIf="showSuggestions && addressSuggestions.length > 0" class="suggestions-card">
          <ion-card-content>
            <ion-text color="primary">
              <h4> Sugerencias de direcciones:</h4>
            </ion-text>
            <ion-list>
              <ion-item
                *ngFor="let suggestion of addressSuggestions"
                button
                (click)="selectAddressSuggestion(suggestion)"
                class="suggestion-item">
                <ion-label>
                  <h3>{{ suggestion.display_name }}</h3>
                  <p *ngIf="suggestion.address.city && suggestion.address.state">
                    {{ suggestion.address.city }}, {{ suggestion.address.state }}
                  </p>
                </ion-label>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <ion-text *ngIf="getFieldError('address_line_1')" color="danger" class="error-text">
          <small>{{ getFieldError('address_line_1') }}</small>
        </ion-text>

        <!-- Direcci贸n l铆nea 2 (opcional) -->
        <ion-item>
          <ion-label position="stacked">Direcci贸n l铆nea 2 (opcional)</ion-label>
          <ion-input
            [(ngModel)]="address.address_line_2"
            name="address_line_2"
            placeholder="Apartamento, suite, etc.">
          </ion-input>
        </ion-item>

        <!-- Ciudad -->
        <ion-item>
          <ion-label position="stacked">Ciudad *</ion-label>
          <ion-input
            [(ngModel)]="address.city"
            name="city"
            placeholder="Ciudad"
            required>
          </ion-input>
        </ion-item>
        <ion-text *ngIf="getFieldError('city')" color="danger" class="error-text">
          <small>{{ getFieldError('city') }}</small>
        </ion-text>

        <!-- Estado -->
        <ion-item>
          <ion-label position="stacked">Estado *</ion-label>
          <ion-input
            [(ngModel)]="address.state"
            name="state"
            placeholder="Estado"
            required>
          </ion-input>
        </ion-item>
        <ion-text *ngIf="getFieldError('state')" color="danger" class="error-text">
          <small>{{ getFieldError('state') }}</small>
        </ion-text>

        <!-- C贸digo Postal -->
        <ion-item>
          <ion-label position="stacked">C贸digo Postal *</ion-label>
          <ion-input
            [(ngModel)]="address.postal_code"
            name="postal_code"
            placeholder="C贸digo postal"
            type="text"
            required>
          </ion-input>
        </ion-item>
        <ion-text *ngIf="getFieldError('postal_code')" color="danger" class="error-text">
          <small>{{ getFieldError('postal_code') }}</small>
        </ion-text>

        <!-- Pa铆s -->
        <ion-item>
          <ion-label position="stacked">Pa铆s *</ion-label>
          <ion-input
            [(ngModel)]="address.country"
            name="country"
            placeholder="Pa铆s"
            required>
          </ion-input>
        </ion-item>
        <ion-text *ngIf="getFieldError('country')" color="danger" class="error-text">
          <small>{{ getFieldError('country') }}</small>
        </ion-text>

        <!-- Tel茅fono -->
        <ion-item>
          <ion-label position="stacked">Tel茅fono *</ion-label>
          <ion-input
            [(ngModel)]="address.phone"
            name="phone"
            placeholder="N煤mero de tel茅fono"
            type="tel"
            required>
          </ion-input>
        </ion-item>
        <ion-text *ngIf="getFieldError('phone')" color="danger" class="error-text">
          <small>{{ getFieldError('phone') }}</small>
        </ion-text>


        <!-- Direcci贸n predeterminada -->
        <ion-item>
          <ion-radio-group [(ngModel)]="address.is_default" name="is_default">
            <ion-radio slot="start" [value]="true"></ion-radio>
            <ion-label>Establecer como direcci贸n predeterminada</ion-label>
          </ion-radio-group>
        </ion-item>

        <!-- Resumen de errores -->
        <ion-card *ngIf="!isFormValid() && hasValidationErrors()" color="danger" class="error-summary">
          <ion-card-content>
            <ion-text color="danger">
              <h3>Por favor corrige los siguientes errores:</h3>
              <ul>
                <li *ngFor="let error of getValidationErrors()">{{ error }}</li>
              </ul>
            </ion-text>
          </ion-card-content>
        </ion-card>

        <!-- Botones -->
        <div class="form-actions">
          <!-- Bot贸n de debug temporal -->
          <ion-button
            expand="block"
            fill="outline"
            color="warning"
            (click)="debugForm()">
            Debug Formulario
          </ion-button>

          <ion-button
            expand="block"
            type="submit"
            [disabled]="!isFormValid() || saving">
            <ion-spinner *ngIf="saving" name="crescent" class="button-spinner"></ion-spinner>
            <span *ngIf="!saving">
              {{ isEditing ? 'Actualizar Direcci贸n' : 'Guardar Direcci贸n' }}
            </span>
          </ion-button>

          <ion-button
            expand="block"
            fill="outline"
            (click)="goBack()"
            [disabled]="saving">
            <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
            Cancelar
          </ion-button>
        </div>
      </form>
    </ion-card-content>
  </ion-card>
</ion-content>
