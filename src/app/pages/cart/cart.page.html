<ion-header>
  <ion-toolbar>
    <ion-title>Mi Carrito</ion-title>
    <ion-button *ngIf="!isCartEmpty()" fill="clear" slot="end" (click)="clearCart()" color="danger">
      <ion-icon name="trash-outline"></ion-icon>
    </ion-button>
  </ion-toolbar>
</ion-header>

<ion-content [style.--padding-bottom]="'calc(88px + env(safe-area-inset-bottom))'">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content pullingIcon="chevron-down-circle-outline" refreshingSpinner="crescent"></ion-refresher-content>
  </ion-refresher>

  <div *ngIf="loading" class="ion-text-center ion-padding"><ion-spinner name="crescent"></ion-spinner><p>Cargando carrito...</p></div>

  <div *ngIf="error && !loading && !isOffline()" class="ion-text-center ion-padding error-state">
    <ion-icon name="alert-circle-outline" color="danger" class="error-icon"></ion-icon>
    <h3>Error</h3>
    <p>{{ error }}</p>
    <ion-button fill="outline" (click)="refreshCart()" class="ion-margin-top">Reintentar</ion-button>
  </div>

  <div *ngIf="!loading && !error && isCartEmpty()" class="ion-text-center ion-padding empty-cart">
    <ion-icon name="cart-outline" class="empty-cart-icon"></ion-icon>
    <h2>¡Tu Carrito Está Vacío!</h2>
    <p>Cuando agregues productos, aparecerán aquí.</p>
    <ion-button (click)="continueShopping()" expand="block" fill="outline" class="ion-margin-top">Continuar Comprando</ion-button>
  </div>

  <div *ngIf="!loading && !error && !isCartEmpty()">
    <ion-list *ngIf="cart && cart.items?.length">
      <div *ngFor="let item of cart.items; trackBy: trackByItemId" class="cart-item custom-cart-item">
        <div class="product-image">
          <img [src]="item.product_image || '/assets/images/no-image.png'" [alt]="item.product_name" />
        </div>
        <div class="product-info">
          <div class="product-title">{{ item.product_name }}</div>
          <div class="price">{{ item.unit_price | currency:'MXN' }}</div>
          <div class="total-price">Total: {{ item.total_price | currency:'MXN' }}</div>
          <div *ngIf="!item.is_available" class="not-available">Producto no disponible</div>
        </div>
        <div class="cart-actions">
          <div class="quantity-controls">
            <div class="quantity-selector">
              <ion-button fill="clear" size="small" (click)="decreaseQuantity(item)"><ion-icon name="remove-outline"></ion-icon></ion-button>
              <div class="quantity-input-container">
                <input type="number" [value]="item.quantity" (input)="updateQuantity(item,$event)" (blur)="commitQuantityInput(item,$event)" (keyup.enter)="commitQuantityInput(item,$event)" min="1" max="99" class="quantity-input">
              </div>
              <ion-button fill="clear" size="small" (click)="increaseQuantity(item)"><ion-icon name="add-outline"></ion-icon></ion-button>
            </div>
          </div>
          <div class="remove-btn-container">
            <ion-button fill="clear" color="danger" size="small" (click)="removeFromCart(item)">
              <ion-icon name="trash-outline" class="remove-icon"></ion-icon>
            </ion-button>
          </div>
        </div>
      </div>
    </ion-list>

    <div *ngIf="hasPendingOfflineItems()" class="pending-section">
      <ion-text color="primary"><h4>Productos pendientes de sincronización</h4><p>Estos productos están guardados localmente y se sincronizarán con tu cuenta</p></ion-text>
      <ng-container *ngIf="!isNotAuthenticated(); else loginHint"><ion-button fill="outline" size="small" color="primary" (click)="syncOfflineCart()">Sincronizar ahora</ion-button></ng-container>
      <ng-template #loginHint><ion-text color="medium"><p><small>Inicia sesión para sincronizar estos productos con tu cuenta</small></p></ion-text></ng-template>

      <ion-list *ngIf="offlineCart?.items?.length">
        <ion-item *ngFor="let item of offlineCart?.items; trackBy: trackByItemId" class="cart-item pending-item">
          <ion-thumbnail slot="start" class="product-image"><img [src]="item.product_image || '/assets/images/no-image.png'" [alt]="item.product_name" /></ion-thumbnail>
          <ion-label class="product-info"><h3>{{ item.product_name }}</h3><p class="price">{{ item.unit_price | currency:'MXN' }}</p><p class="total-price">Total: {{ item.total_price | currency:'MXN' }}</p><ion-text color="primary"><small>Guardado localmente</small></ion-text></ion-label>
          <div slot="end" class="quantity-controls"><div class="quantity-selector"><ion-button fill="clear" size="small" (click)="decreaseOfflineQuantity(item)"><ion-icon name="remove-outline"></ion-icon></ion-button><div class="quantity-input-container"><input type="number" [value]="item.quantity" (input)="updateOfflineQuantityFromInput(item,$event)" (blur)="commitOfflineQuantityInput(item,$event)" min="1" max="99" class="quantity-input"></div><ion-button fill="clear" size="small" (click)="increaseOfflineQuantity(item)"><ion-icon name="add-outline"></ion-icon></ion-button></div><ion-button fill="clear" color="danger" size="small" (click)="removeOfflineItem(item)"><ion-icon name="trash-outline"></ion-icon></ion-button></div>
        </ion-item>
      </ion-list>
    </div>

    <ion-list *ngIf="hasOfflineItems()">
      <ion-item *ngFor="let item of offlineCart?.items; trackBy: trackByItemId" class="cart-item offline-item">
        <ion-thumbnail slot="start" class="product-image"><img [src]="item.product_image || '/assets/images/no-image.png'" [alt]="item.product_name" /></ion-thumbnail>
        <ion-label class="product-info"><h3>{{ item.product_name }}</h3><p class="price">{{ item.unit_price | currency:'MXN' }}</p><p class="total-price">Total: {{ item.total_price | currency:'MXN' }}</p><ion-text color="warning"><small>Sin conexión</small></ion-text></ion-label>
        <div slot="end" class="quantity-controls"><div class="quantity-selector"><ion-button fill="clear" size="small" (click)="decreaseOfflineQuantity(item)"><ion-icon name="remove-outline"></ion-icon></ion-button><div class="quantity-input-container"><input type="number" [value]="item.quantity" (input)="updateOfflineQuantityFromInput(item,$event)" (blur)="commitOfflineQuantityInput(item,$event)" min="1" max="99" class="quantity-input"></div><ion-button fill="clear" size="small" (click)="increaseOfflineQuantity(item)"><ion-icon name="add-outline"></ion-icon></ion-button></div><ion-button fill="clear" color="danger" size="small" (click)="removeOfflineItem(item)"><ion-icon name="trash-outline"></ion-icon></ion-button></div>
      </ion-item>
    </ion-list>

    <ion-card class="order-summary">
      <ion-card-content>
        <h3>Resumen de Orden</h3>
        <div class="summary-row"><span>Sub-total</span><span>{{ getTotalSubtotal() | currency:'MXN' }}</span></div>
        <div *ngIf="hasDiscount()" class="summary-row"><span>Descuento</span><span class="discount">-{{ getDiscountAmount() | currency:'MXN' }}</span></div>
        <div class="summary-row"><span>IVA ({{ getVatRatePercent() }}%)</span><span>{{ getVAT() | currency:'MXN' }}</span></div>
        <div class="summary-row"><span>Costo de envío</span><span>{{ getShippingFee() | currency:'MXN' }}</span></div>
        <div class="summary-row total"><span><strong>Total</strong></span><span><strong>{{ getTotalCombined() | currency:'MXN' }}</strong></span></div>
      </ion-card-content>
    </ion-card>

    <div class="checkout-section"><ion-button expand="block" class="checkout-btn" (click)="goToCheckout()">Ir al Checkout <ion-icon name="arrow-forward" slot="end"></ion-icon></ion-button></div>
  </div>
</ion-content>
