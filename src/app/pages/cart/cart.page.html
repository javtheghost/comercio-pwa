<ion-header>
  <ion-toolbar>
    <ion-title>Mi Carrito</ion-title>


    @if (!isCartEmpty()) {
      <ion-button fill="clear" slot="end" (click)="clearCart()" color="danger">
        <ion-icon name="trash-outline"></ion-icon>
      </ion-button>
    }
  </ion-toolbar>
</ion-header>

<ion-content [style.--padding-bottom]="'calc(88px + env(safe-area-inset-bottom))'">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      refreshingSpinner="circles"
      style="--color: var(--ion-color-primary); --refresher-icon-color: var(--ion-color-primary);">
    </ion-refresher-content>
  </ion-refresher>
  <!-- Loading State -->
  @if (loading) {
    <div class="ion-text-center ion-padding">
    <ion-spinner name="crescent"></ion-spinner>
      <p>Cargando carrito...</p>
    </div>
  }

  <!-- Error State -->
  @if (error && !loading && !isOffline()) {
    <div class="ion-text-center ion-padding error-state">
    <ion-icon name="alert-circle-outline" color="danger" class="error-icon"></ion-icon>
    <h3>Error</h3>
    <p>{{ error }}</p>
    <ion-button fill="outline" (click)="refreshCart()" class="ion-margin-top">
        Reintentar
      </ion-button>
    </div>
  }

  <!-- Offline State -->
  @if (isOffline() && !isCartEmpty()) {
    <div class="ion-text-center ion-padding offline-state">
    <ion-icon name="wifi-outline" class="offline-icon"></ion-icon>
    <h2>Modo Sin Conexión</h2>
    <p>Estás viendo tu carrito offline. Los productos se sincronizarán cuando tengas conexión.</p>
    </div>
  }

  <!-- Empty Cart State -->
  @if (!loading && !error && isCartEmpty()) {
    <div class="ion-text-center ion-padding empty-cart">
    <ion-icon name="cart-outline" class="empty-cart-icon"></ion-icon>
    <h2>¡Tu Carrito Está Vacío!</h2>
    <p>Cuando agregues productos, aparecerán aquí.</p>
    <ion-button (click)="continueShopping()" expand="block" fill="outline" class="ion-margin-top">
        Continuar Comprando
      </ion-button>
    </div>
  }

  <!-- Cart with Items -->
  @if (!loading && !error && !isCartEmpty()) {
    <!-- Online Items -->
    @if (cart && cart.items && cart.items.length > 0) {
      <ion-list>
        @for (item of cart.items; track item.id) {
          <ion-item class="cart-item">
          <ion-thumbnail slot="start" class="product-image">
            <img [src]="item.product_image || '/assets/images/no-image.png'" [alt]="item.product_name" />
          </ion-thumbnail>

          <ion-label class="product-info">
            <h3>{{ item.product_name }}</h3>
            <p class="price">{{ item.unit_price | currency:'MXN' }}</p>
            <p class="total-price">Total: {{ item.total_price | currency:'MXN' }}</p>
            @if (!item.is_available) {
              <ion-text color="danger">
                <small>Producto no disponible</small>
              </ion-text>
            }
          </ion-label>

          <!-- Quantity Selector -->
          <div slot="end" class="quantity-controls">
            <div class="quantity-selector">
              <ion-button fill="clear" size="small" (click)="decreaseQuantity(item)" class="quantity-btn">
                <ion-icon name="remove-outline"></ion-icon>
              </ion-button>

              <div class="quantity-input-container">
                <input
                  type="number"
                  [value]="item.quantity"
                  (input)="updateQuantity(item, $event)"
                  (blur)="commitQuantityInput(item, $event)"
                  (keyup.enter)="commitQuantityInput(item, $event)"
                  (click)="selectInput($event)"
                  class="quantity-input"
                  min="1"
                  max="99">
              </div>

              <ion-button fill="clear" size="small" (click)="increaseQuantity(item)" class="quantity-btn">
                <ion-icon name="add-outline"></ion-icon>
              </ion-button>
            </div>

            <!-- Remove Button -->
            <ion-button fill="clear" color="danger" size="small" (click)="removeFromCart(item)" class="remove-btn">
              <ion-icon name="trash-outline"></ion-icon>
            </ion-button>
          </div>
          </ion-item>
        }
      </ion-list>
    }

    <!-- Offline Items (solo cuando realmente está offline) -->
    @if (hasOfflineItems()) {
      <div class="offline-section">
        <ion-text color="warning">
          <h4>Productos agregados sin conexión</h4>
          <p>Estos productos se sincronizarán cuando tengas conexión</p>
        </ion-text>

        <!-- Botón para sincronizar manualmente (solo si no está autenticado) -->
        @if (isNotAuthenticated()) {
          <ion-button
            fill="outline"
            size="small"
            color="warning"
            (click)="syncOfflineCart()"
            class="sync-button">
            <ion-icon name="sync-outline" slot="start"></ion-icon>
            Sincronizar ahora
          </ion-button>
        }
      </div>
    }

    <!-- Pending Items (cuando está online pero tiene items offline pendientes) -->
    @if (hasPendingOfflineItems()) {
      <div class="pending-section">
        <ion-text color="primary">
          <h4>Productos pendientes de sincronización</h4>
          <p>Estos productos están guardados localmente y se sincronizarán con tu cuenta</p>
        </ion-text>

        <!-- Botón para sincronizar manualmente (solo si está autenticado) -->
        @if (!isNotAuthenticated()) {
          <ion-button
            fill="outline"
            size="small"
            color="primary"
            (click)="syncOfflineCart()"
            class="sync-button">
            <ion-icon name="sync-outline" slot="start"></ion-icon>
            Sincronizar ahora
          </ion-button>
        } @else {
          <ion-text color="medium">
            <p><small>Inicia sesión para sincronizar estos productos con tu cuenta</small></p>
          </ion-text>
        }
      </div>

      <ion-list>
        @for (item of offlineCart?.items; track item.id) {
          <ion-item class="cart-item pending-item">
          <ion-thumbnail slot="start" class="product-image">
            <img [src]="item.product_image || '/assets/images/no-image.png'" [alt]="item.product_name" />
          </ion-thumbnail>

          <ion-label class="product-info">
            <h3>{{ item.product_name }}</h3>
            <p class="price">${{ item.unit_price }}</p>
            <p class="total-price">Total: ${{ item.total_price }}</p>
            <ion-text color="primary">
              <small>Guardado localmente</small>
            </ion-text>
          </ion-label>

          <!-- Quantity Selector -->
          <div slot="end" class="quantity-controls">
            <div class="quantity-selector">
              <ion-button fill="clear" size="small" (click)="decreaseOfflineQuantity(item)" class="quantity-btn">
                <ion-icon name="remove-outline"></ion-icon>
              </ion-button>

              <div class="quantity-input-container">
                <input
                  type="number"
                  [value]="item.quantity"
                  (input)="updateOfflineQuantityFromInput(item, $event)"
                  (blur)="commitOfflineQuantityInput(item, $event)"
                  (keyup.enter)="commitOfflineQuantityInput(item, $event)"
                  class="quantity-input"
                  min="1"
                  max="99">
              </div>

              <ion-button fill="clear" size="small" (click)="increaseOfflineQuantity(item)" class="quantity-btn">
                <ion-icon name="add-outline"></ion-icon>
              </ion-button>
            </div>

            <!-- Remove Button -->
            <ion-button fill="clear" color="danger" size="small" (click)="removeOfflineItem(item)" class="remove-btn">
              <ion-icon name="trash-outline"></ion-icon>
            </ion-button>
          </div>
          </ion-item>
        }
      </ion-list>
    }

    <!-- Offline Items List (solo cuando realmente está offline) -->
    @if (hasOfflineItems()) {
      <ion-list>
        @for (item of offlineCart?.items; track item.id) {
          <ion-item class="cart-item offline-item">
          <ion-thumbnail slot="start" class="product-image">
            <img [src]="item.product_image || '/assets/images/no-image.png'" [alt]="item.product_name" />
          </ion-thumbnail>

          <ion-label class="product-info">
            <h3>{{ item.product_name }}</h3>
            <p class="price">${{ item.unit_price }}</p>
            <p class="total-price">Total: ${{ item.total_price }}</p>
            <ion-text color="warning">
              <small>Sin conexión</small>
            </ion-text>
          </ion-label>

          <!-- Quantity Selector -->
          <div slot="end" class="quantity-controls">
            <div class="quantity-selector">
              <ion-button fill="clear" size="small" (click)="decreaseOfflineQuantity(item)" class="quantity-btn">
                <ion-icon name="remove-outline"></ion-icon>
              </ion-button>

              <div class="quantity-input-container">
                <input
                  type="number"
                  [value]="item.quantity"
                  (input)="updateOfflineQuantityFromInput(item, $event)"
                  (blur)="commitOfflineQuantityInput(item, $event)"
                  (keyup.enter)="commitOfflineQuantityInput(item, $event)"
                  class="quantity-input"
                  min="1"
                  max="99">
              </div>

              <ion-button fill="clear" size="small" (click)="increaseOfflineQuantity(item)" class="quantity-btn">
                <ion-icon name="add-outline"></ion-icon>
              </ion-button>
            </div>

            <!-- Remove Button -->
            <ion-button fill="clear" color="danger" size="small" (click)="removeOfflineItem(item)" class="remove-btn">
              <ion-icon name="trash-outline"></ion-icon>
            </ion-button>
          </div>
          </ion-item>
        }
      </ion-list>
    }

    <!-- Order Summary -->
    <ion-card class="order-summary">
      <ion-card-content>
        <h3>Resumen de Orden</h3>

        <div class="summary-row">
          <span>Sub-total</span>
          <span>{{ getTotalSubtotal() | currency:'MXN' }}</span>
        </div>

        @if (hasDiscount()) {
          <div class="summary-row">
          <span>Descuento</span>
            <span class="discount">-{{ getDiscountAmount() | currency:'MXN' }}</span>
          </div>
        }

        <div class="summary-row">
          <span>IVA ({{ getVatRatePercent() }}%)</span>
          <span>{{ getVAT() | currency:'MXN' }}</span>
        </div>

        <div class="summary-row">
          <span>Costo de envío</span>
          <span>{{ getShippingFee() | currency:'MXN' }}</span>
        </div>

        <div class="summary-row total">
          <span><strong>Total</strong></span>
          <span><strong>{{ getTotalCombined() | currency:'MXN' }}</strong></span>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Checkout Button -->
    <div class="checkout-section">
      <ion-button expand="block" class="checkout-btn" (click)="goToCheckout()">
        Ir al Checkout
        <ion-icon name="arrow-forward" slot="end"></ion-icon>
      </ion-button>
    </div>
  }
</ion-content>
