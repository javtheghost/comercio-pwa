<ion-header>
  <ion-toolbar>
    <ion-button fill="clear" slot="start" (click)="goBack()">
      <ion-icon name="arrow-back-outline"></ion-icon>
    </ion-button>
    <ion-title>Detalles del Producto</ion-title>
    <ion-button fill="clear" slot="end">
      <ion-icon name="heart-outline"></ion-icon>
    </ion-button>
  </ion-toolbar>
</ion-header>

<!-- PRODUCT DETAIL PAGE - Unificado y seguro para ambas ramas -->
<ion-content class="product-detail-content">
  <div class="product-detail-container">
    <!-- Imagen principal del producto -->
    <div class="product-image">
      <img [src]="product.image || 'assets/img/default-product.png'" alt="Imagen del producto" />
    </div>

    <!-- Información principal -->
    <div class="product-info">
      <h1 class="product-title">{{ product.name || 'Producto' }}</h1>
      <p class="product-description">{{ product.description || 'Sin descripción.' }}</p>
    </div>

    <!-- Selector de variantes (componente personalizado, descomenta si lo tienes implementado) -->
    <app-product-variant-selector
      *ngIf="product.variants && product.variants.length > 0"
      [variants]="product.variants"
      [attributes]="product.attributes"
      [basePrice]="(product.price || 0) + ''"
      [baseImage]="product.image || ''"
      [selectedSize]="selectedSize"
      [selectedColor]="selectedColor"
      (selectionChange)="onVariantSelectionChange($event)"
      (variantChange)="onVariantChange($event)">
    </app-product-variant-selector>

    <!-- Información de variantes -->
    <div *ngIf="variantInfo?.needs_variants">
      <div class="variant-info">
        <span *ngIf="variantInfo?.size_guide"><strong>Guía de tallas:</strong> {{ variantInfo?.size_guide || '' }}</span>
        <span *ngIf="variantInfo?.display_name"><strong>Tipo de tallas:</strong> {{ variantInfo?.display_name || '' }}</span>
        <p class="available-options" *ngIf="variantInfo?.available_materials?.length">
          <strong>Materiales disponibles:</strong> {{ (variantInfo?.available_materials || []).join(', ') }}
        </p>
      </div>
    </div>
    <div class="no-variants" *ngIf="variantInfo && !variantInfo.needs_variants">
      <span>No hay variantes para este producto.</span>
    </div>

    <!-- Estado de carga de variantes -->
    <div *ngIf="loadingVariants" class="loading-variants">
      <ion-spinner name="crescent"></ion-spinner> Cargando variantes...
    </div>

    <!-- Precio y stock -->
    <div class="product-purchase-info">
      <span class="price-amount">${{ currentPrice || product.price }}</span>
      <span class="stock-info" *ngIf="currentStock > 0">{{ currentStock }} disponibles</span>
      <span class="stock-info" *ngIf="currentStock <= 0">Agotado</span>
    </div>

    <!-- Botón de agregar al carrito -->
    <button class="add-to-cart-btn" [disabled]="currentStock <= 0 || addingToCart" (click)="addToCart()">
      <ion-spinner *ngIf="addingToCart" name="crescent" class="button-spinner"></ion-spinner>
      <span *ngIf="!addingToCart">Agregar al Carrito</span>
      <span *ngIf="addingToCart">Agregando...</span>
    </button>

    <!-- Toast de confirmación (componente personalizado) -->
    <app-add-to-cart-toast
      [show]="showToast"
      [productName]="toastProductName"
      [productImage]="toastProductImage"
      [selectedSize]="toastSelectedSize"
      [selectedColor]="toastSelectedColor"
      [price]="toastPrice"
      (close)="showToast = false">
    </app-add-to-cart-toast>
  </div>
</ion-content>

