<ion-header>
  <ion-toolbar>
    <ion-button fill="clear" slot="start" (click)="goBack()">
      <ion-icon name="arrow-back-outline"></ion-icon>
    </ion-button>
    <ion-title>Detalles del Producto</ion-title>
    <ion-button fill="clear" slot="end" (click)="toggleFavorite()" aria-label="Favorito">
      <ion-icon [name]="product?.isFavorite ? 'heart' : 'heart-outline'" [color]="product?.isFavorite ? 'danger' : 'medium'"></ion-icon>
    </ion-button>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ng-container *ngIf="showContent">
    <div *ngIf="product" class="product-container">
      <!-- Product Image Section -->
      <div class="product-image-section">
        <img [src]="product.image" [alt]="product.name" class="product-image">
        <ion-badge
          *ngIf="product.discount"
          color="danger"
          class="discount-badge">
          -{{ product.discount }}%
        </ion-badge>
      </div>

      <!-- Product Information -->
      <div class="product-info">
        <h1 class="product-name">{{ product.name }}</h1>
        <div class="product-price">
          <span class="current-price">${{ product.price }}</span>
          <span class="original-price" *ngIf="product.originalPrice">${{ product.originalPrice }}</span>
        </div>
        <p class="product-description" *ngIf="product.description">
          {{ product.description }}
        </p>
        <!-- Variant Selector Component y detalles de variantes -->
        <div *ngIf="!loadingVariants && variantInfo as vInfo">
          <!-- Mostrar selector cuando existan variantes reales o cuando el backend entregue opciones de variantes -->
          <ng-container *ngIf="(product.variants && product.variants.length > 0) || vInfo.needs_variants; else singleSizeBlock">
            <app-product-variant-selector
              [variants]="product.variants || []"
              [attributes]="product.attributes || []"
              [attributeAssignments]="product.attribute_assignments || []"
              [basePrice]="product.price || '0'"
              [baseImage]="product.image || ''"
              [baseStock]="product.track_stock ? productBaseStock : 999"
              [branchProducts]="product.branch_products || []"
              [selectedSize]="selectedSize"
              [selectedColor]="selectedColor"
              [availableSizesOverride]="vInfo.available_sizes || []"
              [availableColorsOverride]="vInfo.available_colors || []"
              (selectionChange)="onVariantSelectionChange($event)"
              (variantChange)="onVariantChange($event)">
            </app-product-variant-selector>
          </ng-container>

          <!-- Detalles de variantes y guía -->
          <div class="variant-info" *ngIf="(product.variants && product.variants.length > 0) || vInfo.needs_variants">
            <div class="size-guide">
              <p class="size-guide-text">
                <ion-icon name="information-circle-outline"></ion-icon>
                {{ vInfo.size_guide }}
              </p>
            </div>
            <div class="variant-details">
              <p class="variant-type">
                <strong>Tipo de tallas:</strong> {{ vInfo.display_name }}
              </p>
              <p class="available-options" *ngIf="vInfo.available_materials && vInfo.available_materials.length > 0">
                <strong>Materiales disponibles:</strong> {{ vInfo.available_materials.join(', ') }}
              </p>
            </div>
          </div>
          <ng-template #singleSizeBlock>
            <div class="no-variants" *ngIf="(!product.variants || product.variants.length === 0) && !vInfo.needs_variants">
              <p class="no-variants-text">
                <ion-icon name="checkmark-circle-outline"></ion-icon>
                Producto de talla única - No requiere selección de variantes
              </p>
            </div>
          </ng-template>
        </div>
        <!-- Loading de variantes -->
        <div *ngIf="loadingVariants" class="loading-variants">
          <ion-spinner name="crescent"></ion-spinner>
          <p>Cargando opciones de variantes...</p>
        </div>
      </div>
    </div>
    <!-- Loading or Error State -->
    <div *ngIf="loading" class="loading-container">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Cargando producto...</p>
    </div>
    <div *ngIf="!loading && error" class="error-container">
      <ion-icon name="alert-circle-outline" style="font-size: 48px; color: #eb445a;"></ion-icon>
      <h3>{{ error }}</h3>
      <ion-button color="primary" (click)="goBack()">Volver</ion-button>
    </div>
  </ng-container>

</ion-content>

<!-- Bottom Action Bar -->
<div class="action-bar" *ngIf="!loading && !error && product && showContent">
  <div class="price-section">
    <span class="price-label">Precio</span>
    <span class="price-amount">${{ currentPrice || product.price }}</span>
    <span class="stock-info" *ngIf="!selectionMissing && currentStock > 0">
      {{ currentStock }} disponibles
    </span>
  </div>
  <ion-button
    class="add-to-cart-btn"
    (click)="addToCart()"
    [disabled]="!canAddToCart">
    @if (addingToCart) {
      <ion-spinner name="crescent" slot="start"></ion-spinner>
    } @else {
      <ion-icon name="cart-outline" slot="start"></ion-icon>
    }
    {{ selectionMissing ? 'Selecciona opciones' : (currentStock <= 0 ? 'Agotado' : (addingToCart ? 'Agregando...' : 'Agregar al Carrito')) }}
  </ion-button>
</div>

<!-- Toast de confirmación -->
<app-add-to-cart-toast
  [show]="showToast"
  [productName]="toastProductName"
  [productImage]="toastProductImage"
  [selectedSize]="toastSelectedSize"
  [selectedColor]="toastSelectedColor"
  [price]="toastPrice"
  (close)="closeToast()">
</app-add-to-cart-toast>

