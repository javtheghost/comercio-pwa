<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Descubrir</ion-title>
    @if (isOffline()) {
      <ion-chip slot="end" color="warning" class="offline-chip">
        <ion-icon name="wifi-outline"></ion-icon>
        <ion-label>Sin conexión</ion-label>
      </ion-chip>
    }
  </ion-toolbar>

  <!-- Barra de búsqueda fija -->
  <ion-toolbar>
    <ion-searchbar
      placeholder="Buscar productos..."
      (ionInput)="onSearchChange($event)"
      [debounce]="300"
      class="fixed-searchbar">
    </ion-searchbar>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" scrollEvents="true" (ionScroll)="onContentScroll($event)">
  <!-- Botón flotante para volver arriba -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="showScrollTop">
    <ion-fab-button class="custom-scrolltop-btn" (click)="scrollToTop()">
      <ion-icon name="arrow-up-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <h3 class="ion-padding-start text-sm font-weight-semibold">Categorías</h3>
  <!-- Filtros de categorías -->
  <div class="categories-container">
    <!-- Skeleton para categorías mientras cargan -->
    <div *ngIf="loadingCategories" class="categories-skeleton">
      <div class="skeleton-chip" *ngFor="let item of [1,2,3,4,5]"></div>
    </div>

    <!-- Categorías reales cuando están cargadas -->
    <div *ngIf="!loadingCategories" class="categories-scroll">
      <div class="categories-wrapper">
        <!-- Chip "Todas" al inicio -->
        <ion-chip
          [color]="null"
          (click)="filterByCategory(null)"
          [class]="'category-chip' + (isCategoryActive(null) ? ' active' : '')">
          Todas
        </ion-chip>

        <!-- Categorías dinámicas -->
        <ion-chip
          *ngFor="let category of categories"
          [color]="null"
          (click)="filterByCategory(category.id)"
          [class]="'category-chip' + (isCategoryActive(category.id) ? ' active' : '')">
          {{ category.name }}
        </ion-chip>
      </div>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="main-content" *ngIf="showContent">

  <!-- Pull-to-refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      refreshingSpinner="circles"
      style="--color: var(--ion-color-primary); --refresher-icon-color: var(--ion-color-primary);">
    </ion-refresher-content>
  </ion-refresher>

    <!-- Estado de carga con skeletons -->
    <div *ngIf="loading" class="loading-container">
      <div class="skeleton-grid">
        <div class="skeleton-card" *ngFor="let item of [1,2,3,4,5,6]">
          <div class="skeleton-image"></div>
          <div class="skeleton-content">
            <div class="skeleton-title"></div>
            <div class="skeleton-price"></div>
            <div class="skeleton-description"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Estado de error -->
    <div *ngIf="!loading && error" class="error-state">
      <ion-icon name="warning-outline" class="error-icon"></ion-icon>
      <h3>Error al cargar productos</h3>
      <p>{{ errorMessage }}</p>
      <ion-button
        color="primary"
        (click)="ionViewWillEnter()"
        fill="outline">
        Reintentar
      </ion-button>
    </div>

    <!-- Estado vacío -->
    <div *ngIf="!loading && !error && products.length === 0" class="empty-state">
      <ion-icon name="search-outline" class="empty-icon"></ion-icon>
      <h3>No se encontraron productos</h3>
      <p>Intenta con otros términos de búsqueda o categorías</p>
    </div>

         <!-- Grid de productos -->
     <div *ngIf="!loading && !error && products.length > 0" class="products-grid">
       <ion-card
         *ngFor="let product of products"
         class="product-card"
         (click)="goToProductDetail(product)">

         <div class="product-image-container">
           <img
             [src]="getProductImageUrl(product)"
             [alt]="product.name"
             class="product-image"
             loading="lazy">

           <!-- Botón de favorito -->
           <ion-button
             fill="clear"
             size="small"
             class="favorite-btn"
             (click)="toggleFavorite(product); $event.stopPropagation()">
             <ion-icon
               [name]="product.isFavorite ? 'heart' : 'heart-outline'"
               [color]="product.isFavorite ? 'danger' : 'medium'">
             </ion-icon>
           </ion-button>
         </div>

         <ion-card-content class="product-content">
           <ion-card-title class="product-title">
             {{ product.name }}
           </ion-card-title>

           <div class="product-price-container">
             <span class="current-price">
               ${{ product.price }}
             </span>

           </div>

           <ion-card-subtitle class="product-description">
             {{ product.description }}
           </ion-card-subtitle>

           <div class="product-category" *ngIf="product.category">
             <ion-chip size="small" color="light">
               {{ product.category.name }}
             </ion-chip>
           </div>

           <!-- Botón de agregar al carrito -->
           <div class="add-to-cart-container">
             <ion-button
               fill="outline"
               size="small"
               class="add-to-cart-btn"
               (click)="addToCart(product); $event.stopPropagation()"
               [disabled]="!product.is_active">
               <ion-icon name="cart-outline"></ion-icon>
               <span>Agregar</span>
             </ion-button>
           </div>
         </ion-card-content>
       </ion-card>
     </div>

    <!-- INFINITE SCROLL - DENTRO DEL CONTENIDO PRINCIPAL -->
    <ion-infinite-scroll
      *ngIf="!loading && !error && hasMoreProducts"
      threshold="100px"
      (ionInfinite)="loadMoreProducts($event)">
      <ion-infinite-scroll-content
        loadingSpinner="bubbles"
        loadingText="Cargando más productos...">
      </ion-infinite-scroll-content>
    </ion-infinite-scroll>

    <!-- Información de paginación -->
    <div *ngIf="!loading && !error && products.length > 0" class="pagination-info">
      <ion-chip size="small" color="primary">
        <ion-icon name="information-circle-outline"></ion-icon>
        <span>Página {{ currentPage }} - {{ products.length }} productos</span>
      </ion-chip>
    </div>

    <!-- Mensaje cuando no hay más productos -->
    <div *ngIf="!loading && !error && !hasMoreProducts && products.length > 0"
         class="no-more-products">
      <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
      <p>Has visto todos los productos disponibles</p>
    </div>
  </div>
</ion-content>

<!-- Toast de confirmación mejorado -->
<app-add-to-cart-toast
  [show]="showToast"
  [productName]="toastProductName"
  [productImage]="toastProductImage"
  [selectedSize]="toastSelectedSize"
  [selectedColor]="toastSelectedColor"
  [price]="toastPrice"
  (close)="closeToast()">
</app-add-to-cart-toast>
