<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Descubrir</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Barra de b√∫squeda -->
  <div class="search-container">
    <ion-searchbar
      placeholder="Buscar ropa..."
      (ionInput)="onSearchChange($event)"
      [debounce]="300">
    </ion-searchbar>

    <!-- Bot√≥n de prueba temporal -->
    <ion-button
      color="danger"
      size="small"
      (click)="testClick()">
      ‚úî TEST CLICK
    </ion-button>

    <!-- Bot√≥n de prueba adicional -->
    <ion-button
      color="primary"
      size="small"
      (click)="testClick()">
      üîß TEST 2
    </ion-button>

    <!-- Bot√≥n HTML nativo para comparar -->
    <button
      type="button"
      style="background: #3880ff; color: white; border: none; padding: 8px 16px; border-radius: 8px; margin-left: 8px;"
      (click)="testClick()">
      üéØ HTML NATIVE
    </button>

    <!-- Bot√≥n de prueba de scroll -->
    <button
      type="button"
      style="background: #10dc60; color: white; border: none; padding: 8px 16px; border-radius: 8px; margin-left: 8px;"
      (click)="testScroll()">
      üìú TEST SCROLL
    </button>

    <!-- Bot√≥n de prueba de infinite scroll -->
    <button
      type="button"
      style="background: #ff6b35; color: white; border: none; padding: 8px 16px; border-radius: 8px; margin-left: 8px;"
      (click)="forceLoadMoreProducts()">
      üîÑ INFINITE SCROLL
    </button>

    <!-- Bot√≥n para verificar estado del scroll -->
    <button
      type="button"
      style="background: #7044ff; color: white; border: none; padding: 8px 16px; border-radius: 8px; margin-left: 8px;"
      (click)="checkScrollStatus()">
      üîç CHECK SCROLL
    </button>
  </div>

  <!-- Filtros de categor√≠as -->
  <div class="categories-container">
    <!-- Skeleton para categor√≠as mientras cargan -->
    <div *ngIf="loadingCategories" class="categories-skeleton">
      <div class="skeleton-chip" *ngFor="let item of [1,2,3,4,5]"></div>
    </div>

    <!-- Categor√≠as reales cuando est√°n cargadas -->
    <div *ngIf="!loadingCategories">
      <ion-chip
        [color]="null"
        (click)="filterByCategory(null)"
        class="category-chip">
        Todas
      </ion-chip>

      <ion-chip
        *ngFor="let category of categories"
        [color]="null"
        (click)="filterByCategory(category.id)"
        class="category-chip">
        {{ category.name }}
      </ion-chip>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="main-content">

    <!-- Estado de carga con skeletons -->
    <div *ngIf="loading" class="loading-container">
      <div class="skeleton-grid">
        <div class="skeleton-card" *ngFor="let item of [1,2,3,4,5,6]">
          <div class="skeleton-image"></div>
          <div class="skeleton-content">
            <div class="skeleton-title"></div>
            <div class="skeleton-price"></div>
            <div class="skeleton-description"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Estado de error -->
    <div *ngIf="!loading && error" class="error-state">
      <ion-icon name="warning-outline" class="error-icon"></ion-icon>
      <h3>Error al cargar productos</h3>
      <p>{{ errorMessage }}</p>
      <ion-button
        color="primary"
        (click)="ionViewWillEnter()"
        fill="outline">
        Reintentar
      </ion-button>
    </div>

    <!-- Estado vac√≠o -->
    <div *ngIf="!loading && !error && products.length === 0" class="empty-state">
      <ion-icon name="search-outline" class="empty-icon"></ion-icon>
      <h3>No se encontraron productos</h3>
      <p>Intenta con otros t√©rminos de b√∫squeda o categor√≠as</p>
    </div>

         <!-- Grid de productos -->
     <div *ngIf="!loading && !error && products.length > 0" class="products-grid">
       <ion-card
         *ngFor="let product of products"
         class="product-card"
         (click)="goToProductDetail(product)">

         <div class="product-image-container">
           <img
             [src]="getProductImageUrl(product)"
             [alt]="product.name"
             class="product-image"
             loading="lazy">

           <!-- Bot√≥n de favorito -->
           <ion-button
             fill="clear"
             size="small"
             class="favorite-btn"
             (click)="toggleFavorite(product); $event.stopPropagation()">
             <ion-icon
               [name]="product.isFavorite ? 'heart' : 'heart-outline'"
               [color]="product.isFavorite ? 'danger' : 'medium'">
             </ion-icon>
           </ion-button>
         </div>

         <ion-card-content class="product-content">
           <ion-card-title class="product-title">
             {{ product.name }}
           </ion-card-title>

           <div class="product-price-container">
             <span class="current-price">
               ${{ product.price }}
             </span>

           </div>

           <ion-card-subtitle class="product-description">
             {{ product.description }}
           </ion-card-subtitle>

           <div class="product-category">
             <ion-chip size="small" color="light">
               {{ product.category.name }}
             </ion-chip>
           </div>
         </ion-card-content>
       </ion-card>
     </div>

    <!-- INFINITE SCROLL - DENTRO DEL CONTENIDO PRINCIPAL -->
    <ion-infinite-scroll
      *ngIf="!loading && !error && hasMoreProducts"
      threshold="100px"
      (ionInfinite)="loadMoreProducts($event)">
      <ion-infinite-scroll-content
        loadingSpinner="bubbles"
        loadingText="Cargando m√°s productos...">
      </ion-infinite-scroll-content>
    </ion-infinite-scroll>

    <!-- Informaci√≥n de paginaci√≥n -->
    <div *ngIf="!loading && !error && products.length > 0" class="pagination-info">
      <ion-chip size="small" color="primary">
        <ion-icon name="information-circle-outline"></ion-icon>
        <span>P√°gina {{ currentPage }} - {{ products.length }} productos</span>
      </ion-chip>
    </div>

    <!-- Mensaje cuando no hay m√°s productos -->
    <div *ngIf="!loading && !error && !hasMoreProducts && products.length > 0"
         class="no-more-products">
      <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
      <p>Has visto todos los productos disponibles</p>
    </div>
  </div>
</ion-content>
