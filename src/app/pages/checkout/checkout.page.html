<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/cart"></ion-back-button>
    </ion-buttons>
    <ion-title>Checkout</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Checkout</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="checkout-container">

    <!-- Error Message -->
    @if (error) {
      <ion-card color="danger">
        <ion-card-content>
          <ion-text color="light">
            <p>{{ error }}</p>
          </ion-text>
        </ion-card-content>
      </ion-card>
    }

    <!-- Loading Spinner -->
    @if (loading) {
      <div class="loading-container">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Procesando orden...</p>
      </div>
    }

    <!-- Checkout Form -->
    @if (!loading && cart && !isCartEmpty()) {

      <!-- Direcci贸n y M茅todo (layout stacked) -->
      <ion-card class="address-card">
        <ion-card-header>
          <ion-card-title>Direcci贸n de Env铆o</ion-card-title>
          <ion-card-subtitle>Selecciona o ingresa la direcci贸n de entrega</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          @if (userAddresses.length > 0) {
            <div class="address-mode-switch">
              <ion-segment [(ngModel)]="addressMode" (ionChange)="onAddressModeChange()">
                <ion-segment-button value="existing">
                  <ion-label>Guardadas</ion-label>
                </ion-segment-button>
                <ion-segment-button value="new">
                  <ion-label>Nueva</ion-label>
                </ion-segment-button>
              </ion-segment>
            </div>
          }

          <!-- Direcciones guardadas -->
          @if (addressMode === 'existing' && userAddresses.length > 0) {
            <div class="saved-addresses">
              @for (address of userAddresses; track address.id) {
                <div class="address-item" (click)="selectedAddressId = address.id ?? null; onExistingAddressSelected()" [class.selected]="selectedAddressId === address.id">
                  <div class="address-radio">
                    <ion-icon name="radio-button-on" *ngIf="selectedAddressId === address.id" color="primary"></ion-icon>
                    <ion-icon name="radio-button-off" *ngIf="selectedAddressId !== address.id" color="medium"></ion-icon>
                  </div>
                  <div class="address-content">
                    <div class="address-header">
                      <strong>{{ address.first_name }} {{ address.last_name }}</strong>
                      @if (address.is_default) {
                        <ion-badge color="success">Predeterminada</ion-badge>
                      }
                    </div>
                    <p class="address-text">{{ formatAddress(address) }}</p>
                    <p class="address-phone"> {{ address.phone }}</p>
                  </div>
                  @if (selectedAddressId === address.id) {
                    <ion-icon name="checkmark-circle" class="address-check" color="success"></ion-icon>
                  }
                </div>
              }
            </div>
            @if (!selectedAddressId) {
              <div class="help-text">
                <ion-text color="medium">Selecciona una direcci贸n para continuar.</ion-text>
              </div>
            }
          }

          <!-- Formulario nueva direcci贸n -->
          @if (addressMode === 'new' || userAddresses.length === 0) {
            @if (userAddresses.length === 0) {
              <div class="no-addresses-hint">
                <ion-icon name="location-outline" color="medium"></ion-icon>
                <p>No tienes direcciones guardadas. Ingresa una nueva.</p>
              </div>
            }
            <div class="new-address-form">
              <div class="form-grid">
                <ion-item>
                  <ion-label position="stacked">Nombre *</ion-label>
                  <ion-input [(ngModel)]="shippingAddress.firstName" (ionInput)="onNameInput($event, 'firstName')" placeholder="Nombre" maxlength="50" required></ion-input>
                </ion-item>
                <ion-item>
                  <ion-label position="stacked">Apellido *</ion-label>
                  <ion-input [(ngModel)]="shippingAddress.lastName" (ionInput)="onNameInput($event, 'lastName')" placeholder="Apellido" maxlength="50" required></ion-input>
                </ion-item>
              </div>
              <ion-item>
                <ion-label position="stacked">Direcci贸n *</ion-label>
                <ion-textarea auto-grow="true" [(ngModel)]="shippingAddress.address" (ionInput)="onAddressInput($event)" placeholder="Calle, n煤mero, colonia" maxlength="200" required></ion-textarea>
              </ion-item>
              <div class="form-grid">
                <ion-item>
                  <ion-label position="stacked">Ciudad *</ion-label>
                  <ion-select 
                    [(ngModel)]="shippingAddress.city" 
                    (ionChange)="onAddressFieldChange()" 
                    placeholder="Selecciona ciudad"
                    interface="action-sheet"
                    [disabled]="!shippingAddress.state || ciudadesFiltradas.length === 0">
                    <ion-select-option *ngFor="let ciudad of ciudadesFiltradas" [value]="ciudad">
                      {{ ciudad }}
                    </ion-select-option>
                  </ion-select>
                </ion-item>
                <ion-item>
                  <ion-label position="stacked">Estado *</ion-label>
                  <ion-select 
                    [(ngModel)]="shippingAddress.state" 
                    (ionChange)="onStateChange(); onAddressFieldChange()" 
                    placeholder="Selecciona estado"
                    interface="action-sheet">
                    <ion-select-option *ngFor="let estado of estados" [value]="estado">
                      {{ estado }}
                    </ion-select-option>
                  </ion-select>
                </ion-item>
              </div>
              <div class="form-grid">
                <ion-item>
                  <ion-label position="stacked">C贸digo Postal *</ion-label>
                  <ion-input [(ngModel)]="shippingAddress.zipCode" (ionInput)="onZipCodeInput($event)" placeholder="C.P." inputmode="numeric" maxlength="5" required></ion-input>
                </ion-item>
                <ion-item>
                  <ion-label position="stacked">Tel茅fono *</ion-label>
                  <ion-input [(ngModel)]="shippingAddress.phone" (ionInput)="onPhoneInput($event)" placeholder="Tel茅fono" type="tel" inputmode="numeric" maxlength="10" required></ion-input>
                </ion-item>
              </div>
              <div class="save-address-action">
                <ion-button expand="block" fill="outline" color="primary" (click)="saveNewAddress()" [disabled]="savingAddress || !isNewAddressBasicFilled()">
                  <ion-icon name="save-outline" slot="start"></ion-icon>
                  <ion-spinner *ngIf="savingAddress" name="crescent" slot="start"></ion-spinner>
                  <span *ngIf="!savingAddress">Guardar direcci贸n</span>
                  <span *ngIf="savingAddress">Guardando...</span>
                </ion-button>
                <div class="save-hint" *ngIf="!savingAddress && isNewAddressBasicFilled() && !addressErrors.length">
                  Puedes guardar esta direcci贸n para usarla despu茅s
                </div>
                <div class="save-hint secondary-hint" *ngIf="!savingAddress">
                  (Si contin煤as con "Confirmar Pedido" sin guardar la direcci贸n, se usar谩 s贸lo para esta compra y no se guardar谩 en Mis Direcciones.)
                </div>
              </div>
              @if (showAddressErrors && addressErrors.length) {
                <div class="address-errors">
                  <ion-list lines="none">
                    @for (err of addressErrors; track err) {
                      <ion-item color="danger" class="error-item">
                        <ion-icon name="alert-circle" slot="start"></ion-icon>
                        <ion-label>{{ err }}</ion-label>
                      </ion-item>
                    }
                  </ion-list>
                </div>
              }
            </div>
          }

          @if (addressesLoading) {
            <div class="loading-container small">
              <ion-spinner name="crescent"></ion-spinner>
              <p>Cargando direcciones...</p>
            </div>
          }
        </ion-card-content>
      </ion-card>

      <!-- M茅todo de Pago -->
      <ion-card class="payment-card">
        <ion-card-header>
          <ion-card-title>M茅todo de Pago</ion-card-title>
          <ion-card-subtitle>Actualmente s贸lo disponible efectivo</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <div class="payment-option selected">
            <div class="payment-left">
              <ion-icon name="cash-outline" class="payment-icon"></ion-icon>
              <div class="payment-info">
                <strong>Efectivo (Contra Entrega)</strong>
                <p>Paga cuando llegue tu pedido</p>
              </div>
            </div>
            <ion-icon name="checkmark-circle" color="success" class="payment-selected"></ion-icon>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Resumen del Pedido -->
      <ion-card class="summary-card">
        <ion-card-header>
          <ion-card-title>Resumen</ion-card-title>
          <ion-card-subtitle>{{ getTotalItems() }} art铆culos</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <div class="order-summary compact">
            @for (item of cart.items; track item.product_id) {
              <div class="summary-item">
                <div class="item-info">
                  <h4>{{ item.product_name }}</h4>
                  <p>x{{ item.quantity }} 路 ${{ item.unit_price }}</p>
                </div>
                <div class="item-total">${{ item.total_price }}</div>
              </div>
            }
            <div class="summary-totals">
              <div class="total-line">
                <span>Subtotal</span>
                <span>${{ getSubtotal() | number:'1.2-2' }}</span>
              </div>
              <div class="total-line">
                <span>IVA ({{ getVatRatePercent() }}%)</span>
                <span>${{ getTax() | number:'1.2-2' }}</span>
              </div>
              <div class="total-line">
                <span>Env铆o</span>
                <span>${{ getShipping() | number:'1.2-2' }}</span>
              </div>
              <div class="total-line total-final">
                <span>Total</span>
                <span>${{ getTotal() | number:'1.2-2' }}</span>
              </div>
            </div>
          </div>
          <div class="checkout-actions">

            <!-- Bot贸n de debug: forzar creaci贸n de orden (no altera el flujo principal) -->
            <div style="margin-top:8px">
              <ion-button expand="block" size="small"  [disabled]="loading" (click)="debugCreateOrder()">
                <ion-icon name="bag-check-outline" slot="start"></ion-icon>
                Confirmar Pedido ${{ getTotal() | number:'1.2-2' }}
              </ion-button>
            </div>

            <!-- Bot贸n de debug: ir a confirmaci贸n -->
            <div style="margin-top:8px">
              <ion-button expand="block" size="small" fill="outline" color="warning" (click)="goToConfirmation()">
                <ion-icon name="eye-outline" slot="start"></ion-icon>
                Ver Confirmaci贸n (Debug)
              </ion-button>
            </div>

            <!-- Bot贸n de debug: mostrar alert mejorado -->
            <div style="margin-top:8px">
              <ion-button expand="block" size="small" fill="outline" color="success" (click)="showDebugAlert()">
                <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
                Mostrar Alert Mejorado (Debug)
              </ion-button>
            </div>

            <!-- Bot贸n de debug: mostrar modal de confirmaci贸n -->
            <div style="margin-top:8px">
              <ion-button expand="block" size="small" fill="outline" color="tertiary" (click)="showDebugModal()">
                <ion-icon name="eye-outline" slot="start"></ion-icon>
                Mostrar Modal (Debug)
              </ion-button>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    }

    <!-- Carrito Vac铆o -->
    @if (!loading && isCartEmpty()) {
      <div class="empty-cart">
        <ion-card>
          <ion-card-content class="text-center">
            <ion-icon name="cart-outline" size="large" color="medium"></ion-icon>
            <h2>Tu carrito est谩 vac铆o</h2>
            <p>Agrega productos antes de proceder al checkout</p>
            <ion-button fill="outline" (click)="goBack()">
              Volver al Carrito
            </ion-button>
          </ion-card-content>
        </ion-card>
      </div>
    }
  </div>
</ion-content>


<!-- Modal de Confirmaci贸n de Orden -->
<ion-modal [isOpen]="showOrderSuccessModal" [backdropDismiss]="true" (didDismiss)="closeOrderModal()">
  <ion-header>
    <ion-toolbar color="success">
      <ion-title>隆Orden Confirmada!</ion-title>
      <ion-buttons slot="end">
        <ion-button fill="clear" (click)="closeOrderModal()">
          <ion-icon name="close" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
  </ion-header>
  <ion-content class="ion-padding">
    <div class="success-content">
      <div class="success-icon">
        <ion-icon name="checkmark-circle" size="large" color="success"></ion-icon>
      </div>

      <h2>隆Tu pedido ha sido confirmado!</h2>

      <div class="order-details">
        <ion-card>
          <ion-card-content>
            <div class="detail-row">
              <span class="label">N煤mero de Orden:</span>
              <span class="value">{{ orderConfirmation?.orderNumber || 'N/A' }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Total:</span>
              <span class="value">${{ orderConfirmation?.total | number:'1.2-2' }}</span>
            </div>
            <div class="detail-row">
              <span class="label">M茅todo de Pago:</span>
              <span class="value">Efectivo (Contra Entrega)</span>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      <div class="email-notification">
        <ion-icon name="mail-outline" color="primary"></ion-icon>
        <p>Te enviaremos actualizaciones del estado de tu pedido a tu correo electr贸nico.</p>
      </div>

      <div class="modal-actions">
        <ion-button expand="block" fill="outline" (click)="goToOrders()">
          <ion-icon name="list-outline" slot="start"></ion-icon>
          Ver Mis rdenes
        </ion-button>

        <ion-button expand="block" (click)="goToHome()">
          <ion-icon name="home-outline" slot="start"></ion-icon>
          Ir al Inicio
        </ion-button>
      </div>
    </div>
  </ion-content>
</ion-modal>

<!-- Tabs Navigation -->
<app-tabs></app-tabs>
